#include <filesystem>
#include <algorithm>
#include <stdexcept>
#include <iostream>
#include <iterator>
#include <sstream>
#include <fstream>
#include <iomanip>
#include <string>
#include <ctime>

using namespace std;
class PlayCard
{
    private:
    string MahjongCH[11] = {"萬", "筒", "條", "東", "西", "南", "北", "中", "發", "白", ""};
    string MahjongN[10] = {"1", "2", "3", "4", "5", "6", "7", "8", "9", ""};
    int Mahjong[136];
    int Current_location = 0;
    int player[3][14];
    int playerbump[3][14];
    int playermemory[3] = {0};
    int people, win1;
    int playerlog = 0;
    int inMahjong = 109;
    
    public:
    void reset()
    {
        fill(begin(Mahjong), end(Mahjong), 0);
        fill(&player[0][0], &player[0][0] + sizeof(player)/sizeof(int), 109);
        fill(&playerbump[0][0], &playerbump[0][0] + sizeof(playerbump)/sizeof(int), 109);
        fill(begin(playermemory), end(playermemory), 0);
        Current_location = 0;
        playerlog = 0;
        inMahjong = 109;
        win1 = 0;
        dealing_cards();
    }
    void dealing_cards()
    {
        cout << "請輸入1~3人玩家：" << endl;
        abc(&people, 3);
        for (int n = 0; n < 4; n++)
        {
            for (int i = 0; i < 10; i++)
            {
                if (i < 3)
                {
                    for (int j = 0; j < 9; j++)
                    {
                        Mahjong[Current_location] = i * 10 + j;
                        Current_location++;
                    }
                }
                else
                {
                    Mahjong[Current_location] = i * 10 + 9;
                    Current_location++;
                }
            }
        }
        Current_location = 0;
        shuffle(Mahjong);
        for (int round = 0; round < 3; round++)
        {
            for (int p = 0; p < 3; p++)
            {
                for (int k = 0; k < 4; k++)
                {
                    get_cards(player[p], round * 4 + k);
                    playerbump[p][round * 4 + k] = 109;
                }
            }
        }
        for (int p = 0; p < 3; p++)
        {
            get_cards(player[p], 12);
            player[p][13] = 109;
            playerbump[p][12] = 109;
            playerbump[p][13] = 109;
        }
        start();
    }

    void bubbleSort(int arr[], int n)
    {
        for (int i = 0; i < n - 1; i++)
        {
            for (int j = 0; j < n - i - 1; j++)
            {
                if (arr[j] > arr[j + 1])
                {
                    int temp = arr[j];
                    arr[j] = arr[j + 1];
                    arr[j + 1] = temp;
                }
            }
        }
    }

    void shuffle(int arr[])
    {
        for (int i = 0; i <= rand(); i++)
        {
            int random1 = rand() % 136;
            int random2 = rand() % 136;
            swap(arr[random1], arr[random2]);
        }
    }

    void get_cards(int arr[], int index)
    {
        inMahjong = Mahjong[Current_location++];
        arr[index] = inMahjong;
    }

    int robot_throw(int arr[], int um, int robots)
    {
        int Lost_card = 13 - um * 3;
        for (int i = 12 - um * 3; i >= 0; i--)
        {
            int a = (arr[i + 1] - arr[i]) - (arr[i] - arr[i - 1]);
            int b = i + (abs(a) - abs(a - 1));
            if ((a != 0 || ((arr[i + 1] - arr[i]) * (arr[i] - arr[i - 1])) > 1) && arr[i + 1] != 109)
            {
                if (Lost_card == b || b == 0)
                {
                    return b;
                    break;
                }
                else
                {
                    Lost_card = i + (abs(a) - abs(a - 1));
                    i--;
                }
            }
        }
        return win(arr, um, robots);
    }

    int win(int arr[], int threelog, int pl)
    {
        int three = threelog;
        int tow = 0;
        for (int i = 12 - three * 3; i >= 0; i -= 3)
        {
            if (((arr[i - 1] == arr[i] && arr[i] == arr[i + 1]) || (arr[i - 1] + 1 == arr[i] && arr[i] == arr[i + 1] - 1)) && arr[i] != 109)
            {
                three++;
            }
            else if (arr[i + 1] == arr[i] && arr[i] != 109)
            {
                tow++;
                i++;
            }
            else
            {
                return i + 1;
                break;
            }
        }
        if ((three == 4 && tow == 1) || (three == 0 && tow == 7))
        {
            asd(pl);
            return 9999;
        }
        return 0;
    }

    void bump(int a, int c)
    {
        int yn = 1;
        bubbleSort(player[c], 14);
        for (int i = 0; i < 3; i++)
        {
            for (int j = 0; j < 14; j++)
            {
                if (player[i][j] == a && player[i][j + 1] == a && i != c && player[i][j] != 109)
                {
                    if (i <= people)
                    {
                        cout << "玩家" << i + 1 << endl;
                        printArray(player[i], playerbump[i], 14 - playermemory[i] * 3);
                        cout << "是否要碰牌，要碰輸入 2 否則輸入 輸入 1:" << endl;
                        abc(&yn, 2);
                    }
                    if (yn)
                    {
                        cout << "玩家" << i + 1 << "碰喵～！" << endl;
                        playerbump[i][playermemory[i] * 3] = player[i][j];
                        swap(playerbump[i][playermemory[i] * 3 + 1], player[i][j + 1]);
                        swap(playerbump[i][playermemory[i] * 3 + 2], player[i][j]);
                        bubbleSort(player[i], 14);
                        playermemory[i]++;
                        playerlog = i;
                        if (i <= people) printArray(player[i], playerbump[i], 14 - playermemory[i] * 3);
                        wasd(playerlog);
                        break;
                    }
                }
            }
        }
    }

    void printArray(int arr[], int arr2[], int n)
    {
        for (int i = 1; i < n + 1; i++)
        {
            cout << right << setw(5) << i << " ";
        }
        cout << endl << " ";
        for (int i = 0; i < n; i++)
        {
            cout << right << setw(5) << MahjongN[arr[i] % 10] + MahjongCH[arr[i] / 10] << " ";
        }
        cout << endl << " ";
        for (int i = 0; i < 14; i++)
        {
            cout << right << setw(5) << MahjongN[arr2[i] % 10] + MahjongCH[arr2[i] / 10] << " ";
        }
        cout << endl;
    }

    void throw_away(int pl, int Location)
    {
        int a = player[pl][Location];
        player[pl][Location] = 109;
        cout << "玩家" << pl + 1 << "丟出";
        cout << right << setw(5) << MahjongN[a % 10] + MahjongCH[a / 10] << endl;
        for (int i = 0; i < 3; i++)
        {
            if (i != pl)
            {
                player[i][13] = a;
                bubbleSort(player[i], 14);
                win1 = win(player[i], playermemory[i], i);
                if (win1 == 9999)
                {
                    break;
                }
                for (int j = 0; j < 14; j++)
                {
                    if (player[i][j] == a)
                    {
                        player[i][j] = 109;
                        bubbleSort(player[i], 14);
                        break;
                    }
                }
            }
        }
        if (win1 != 9999)
        {
            bump(a, pl);
            bubbleSort(player[pl], 14);
        }
    }

    void human(int number)
    {
        int dont;
        cout << "請輸入1~" << 14 - playermemory[number] * 3 << "選出要丟棄的牌：" << endl;
        abc(&dont, 14 - playermemory[number] * 3);
        throw_away(number, dont);
    }

    void wasd(int pl)
    {
        if (pl <= people)
        {
            human(pl);
        }
        else
        {
            throw_away(pl, robot_throw(player[pl], playermemory[pl], pl));
        }
    }

    void start()
    {
        int oneplayer;
        while (win1 != 9999 && Current_location != 135)
        {
            oneplayer = playerlog % 3;
            get_cards(player[oneplayer], 13);
            hio(player[oneplayer], oneplayer);
            bubbleSort(player[oneplayer], 14);
            if (oneplayer <= people)
            {
                cout << "玩家" << oneplayer + 1 << endl;
                printArray(player[oneplayer], playerbump[oneplayer], 14 - playermemory[oneplayer] * 3);
                cout << "玩家" << oneplayer + 1 << "摸了";
                cout << right << setw(5) << MahjongN[inMahjong % 10] + MahjongCH[inMahjong / 10] << "  ";
                for (int i = 0; i < 14; i++)
                {
                    if (inMahjong == player[oneplayer][i])
                    {
                        cout << i + 1 << endl;
                        break;
                    }
                }
            }
            win1 = win(player[oneplayer], playermemory[oneplayer], oneplayer);
            if (win1 != 9999)
                wasd(oneplayer);
            playerlog++;
        }
        if (Current_location == 135 && win1 != 9999)
        {
            cout << "流局";
        }
        cout << endl << endl;
    }

    void asd(int p)
    {
        cout << "玩家" << p + 1 << " 和牌！" << endl;
        bubbleSort(player[p], 14);
        printArray(player[p], playerbump[p], 14 - playermemory[p] * 3);
        ofstream out("win.txt", ios::app);
        if (!out)
        {
            cerr << "無法開啟 win.txt 寫入！" << endl;
            return;
        }
        out << "玩家" << p + 1 << " 和牌！" << endl;
        for (int i = 0; i < 14; i++)
        {
            int tile = player[p][i];
            if (tile != 109 && tile / 10 < 11)
            {
                out << MahjongN[tile % 10] + MahjongCH[tile / 10] << " ";
            }
        }
        out << "  ";
        for (int i = 0; i < 14; i++)
        {
            int tile = playerbump[p][i];
            if (tile != 109 && tile / 10 < 11)
            {
                out << MahjongN[tile % 10] + MahjongCH[tile / 10] << " ";
            }
        }
        out << endl << endl;
        out.flush();
        out.close();
    }

    void abc(int *input, int b)
    {
        string line;
        while (true)
        {
            try
            {
                getline(cin, line);
                stringstream ss(line);
                if (!(ss >> *input) || (ss >> ws && !ss.eof()))
                {
                    throw runtime_error("輸入不是有效的整數！");
                }
                if (*input > b || *input < 1)
                {
                    throw runtime_error("輸入值不在範圍內！");
                }
                *input -= 1;
                break;
            }
            catch (const runtime_error &e)
            {
                cout << "錯誤：" << e.what() << " 請重新輸入。\n";
            }
        }
    }

    void hio(int arr[], int a)
    {
        int yn = 1;
        for (int i = 13; i >= 0; i--)
        {
            if (arr[i] == 69)
            {
                if (a <= people)
                {
                    cout << "玩家" << a + 1 << endl;
                    printArray(player[a], playerbump[a], 14 - playermemory[a] * 3);
                    cout << "是否要拔北，要拔北輸入 2 否則輸入 1:" << endl;
                    abc(&yn, 2);
                }
                if (yn)
                {
                    cout << "玩家" << a + 1 << "拔北" << endl;
                    get_cards(arr, i);
                    bubbleSort(arr, 14);
                    hio(arr, a);
                }
                break;
            }
        }
    }
};

int main()
{
    srand((unsigned)time(0));
    PlayCard a;
    int b = 1;
    while (b)
    {
        a.reset();
        cout << "是否再玩一次 是按2否則按1" << endl;
        a.abc(&b, 2);
    }
}